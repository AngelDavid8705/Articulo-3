---
title: "Dataset scraping"
format: html
editor: visual
---

```{r}
library(tidyverse)
library(rvest)
library(stringr)
set.seed(123)

# URLs
story_links <- c(
  "https://www.yourghoststories.com/real-ghost-story.php?story=65",
  "https://www.yourghoststories.com/real-ghost-story.php?story=18550",
  "https://www.yourghoststories.com/real-ghost-story.php?story=20992",
  "https://www.yourghoststories.com/real-ghost-story.php?story=21742",
  "https://www.yourghoststories.com/real-ghost-story.php?story=25088",
  "https://www.yourghoststories.com/real-ghost-story.php?story=25169",
  "https://www.yourghoststories.com/real-ghost-story.php?story=25220",
  "https://www.yourghoststories.com/real-ghost-story.php?story=25437",
  "https://www.yourghoststories.com/real-ghost-story.php?story=25481",
  "https://www.yourghoststories.com/real-ghost-story.php?story=26018",
  "https://www.yourghoststories.com/real-ghost-story.php?story=26856",
  "https://www.yourghoststories.com/real-ghost-story.php?story=27770",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28255",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28262",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28281",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28301",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28325",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28341",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28371",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28378",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28387",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28389",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28390",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28396",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28400",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28406",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28419",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28423",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28426",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28429",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28433",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28435",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28438",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28448",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28452",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28457",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28461",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28462",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28480",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28488",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28497",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28505",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28506",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28508",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28514",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28515",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28516",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28517",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28518",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28520",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28523",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28524",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28525",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28526",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28535",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28536",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28539",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28542",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28543",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28544",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28545",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28547",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28548",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28549",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28550",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28557",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28558",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28563",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28565",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28566",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28570",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28571",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28572",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28573",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28574",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28575",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28577",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28553",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28499",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28451",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28437",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28329",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28121",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28111",
  "https://www.yourghoststories.com/real-ghost-story.php?story=27915",
  "https://www.yourghoststories.com/real-ghost-story.php?story=27821",
  "https://www.yourghoststories.com/real-ghost-story.php?story=27813",
  "https://www.yourghoststories.com/real-ghost-story.php?story=27739",
  "https://www.yourghoststories.com/real-ghost-story.php?story=27715",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28196",
  "https://www.yourghoststories.com/real-ghost-story.php?story=28146",
  "https://www.yourghoststories.com/real-ghost-story.php?story=27846",
  "https://www.yourghoststories.com/real-ghost-story.php?story=27829",
  "https://www.yourghoststories.com/real-ghost-story.php?story=27820",
  "https://www.yourghoststories.com/real-ghost-story.php?story=27792",
  "https://www.yourghoststories.com/real-ghost-story.php?story=27749",
  "https://www.yourghoststories.com/real-ghost-story.php?story=27694",
  "https://www.yourghoststories.com/real-ghost-story.php?story=27658",
  "https://www.yourghoststories.com/real-ghost-story.php?story=27580",
  "https://www.yourghoststories.com/real-ghost-story.php?story=27385"
)

is_missing <- function(x) inherits(x, "xml_missing") || length(x) == 0

get_text_xpath <- function(h, xp) {
  nd <- html_element(h, xpath = xp)
  if (is_missing(nd)) NA_character_ else html_text2(nd)
}

# Catálogo de categorías válidas
known_cats <- c(
  "Haunted Places",
  "Apparitions / Voices / Touches",
  "Children Who See Spirits",
  "Pets / Animals",
  "Haunted Items",
  "Non Human Entities",
  "Misc"
)
cat_pat <- paste0("(?i)\\b(", paste(known_cats, collapse = "|"), ")\\b")

parse_story <- function(url) {
  Sys.sleep(runif(1, 0.5, 1.1))
  h <- read_html(url)

  # Título
  title <- get_text_xpath(h, "(//h1[contains(@class,'storytitle') or self::h1])[1]")

  # Relato
  story <- get_text_xpath(h, "//div[@id='story']")
  if (is.na(story) || nchar(story) < 20) {
    story <- html_elements(h, c("#story",".entry-content","#content","#main","article")) |>
      html_text2() |> paste(collapse = "\n")
  }
  story <- str_squish(story)

  body_txt <- html_element(h, "body") |> html_text2() |>
    str_replace_all("\u00A0", " ") |> str_squish()

  # Fecha
  date <- get_text_xpath(h, "//b[normalize-space()='Date:']/following-sibling::text()[1]")
  if (is.na(date) || date == "") {
    date <- str_match(body_txt, "(?i)\\bDate\\s*:\\s*([0-9]{4}[-/][0-9]{2}[-/][0-9]{2})")[,2]
  }

  # País
  place <- get_text_xpath(h, "//b[normalize-space()='Country:']/following-sibling::a[1]")
  if (is.na(place) || place == "") {
    place <- str_match(
      body_txt,
      "(?i)\\bCountry\\s*:\\s*([A-Z][A-Za-z.'-]+(?:\\s+[A-Z][A-Za-z.'-]+){0,5})\\s*(?=(State\\s*:|Paranormal\\s+Category\\s*:|Date\\s*:|By\\b|$))"
    )[,2]
  }

  # Categorías
  type_nodes <- html_elements(
    h,
    xpath = "(//b[normalize-space()='Paranormal Category:'])[1]/following-sibling::a"
  )
  if (length(type_nodes) > 0) {
    type <- type_nodes |> html_text2() |> str_squish() |> str_c(collapse = " / ")
  } else {
    type <- str_extract(body_txt, cat_pat)
  }

  tibble(title = title, place = place, type = type, story = story, url = url, date = date)
}

parse_story_safe <- function(u) {
  out <- tryCatch(parse_story(u),
                  error = function(e)
                    tibble(title=NA_character_, place=NA_character_,
                           type=NA_character_,  story=NA_character_,
                           url=u,               date=NA_character_))
  if (is.null(out) || nrow(out) == 0) {
    tibble(title=NA_character_, place=NA_character_,
           type=NA_character_,  story=NA_character_,
           url=u,               date=NA_character_)
  } else out
}

# Scraping con limpieza corta
raw_df <- purrr::map_dfr(story_links, parse_story_safe)

final_df <- raw_df |>
  mutate(
    title = str_squish(title),
    place = str_squish(place),
    story = str_squish(story),
    date  = str_squish(date),
    type  = str_extract(type, cat_pat) |> str_to_sentence()
  ) |>
  filter(!is.na(story), nchar(story) > 20) |>
  mutate(
    label = if_else(str_detect(type, regex("^Haunted\\s*places$", ignore_case = TRUE)),
                    "Haunted Places", "Other"),
    id = row_number()
  ) |>
  select(id, label, story, title, place, type, date, url)

write_csv(final_df, "ghostbusters_dataset.csv")

table(final_df$label); nrow(final_df)
final_df |> count(type, sort = TRUE)
final_df |> count(place, sort = TRUE)

```

```{r}
df <- read_csv("ghostbusters_dataset.csv", show_col_types = FALSE)
glimpse(df)
colSums(is.na(df))         
sum(nchar(df$story) <= 20) 

df |> count(label)
df |> count(type, sort = TRUE)
df |> count(place, sort = TRUE)
```

```{}
```

```{}
```
